<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¿Ÿå·å³¶æ—…éŠè¦åŠƒ | Jeju Trip Planner</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœˆï¸</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1', // Indigo
                            600: '#4f46e5',
                            700: '#4338ca',
                        },
                        secondary: '#0ea5e9', // Sky
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0', // Border
                            300: '#cbd5e1',
                            500: '#64748b', // Subtext
                            800: '#1e293b', // Text
                            900: '#0f172a',
                        }
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'float': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Styles */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100dvh;
            background-color: #f8fafc; /* Slate-50 */
            color: #1e293b; /* Slate-800 */
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Content Area */
        #app-content {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Modern Timeline Styles */
        .timeline-container {
            position: relative;
            padding-left: 2rem;
        }
        .timeline-line {
            position: absolute;
            left: 0.75rem; /* Center of the dot (w-6 / 2) */
            top: 0.5rem;
            bottom: -1.5rem; /* Connect to next item */
            width: 2px;
            background-color: #e2e8f0; /* Slate-200 */
            z-index: 0;
        }
        .timeline-item:last-child .timeline-line {
            bottom: auto;
            height: 100%; /* Stop at the last item */
        }

        /* FAB Pulse */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .fab-btn { animation: pulse-ring 2s infinite; }

        /* Custom Form Elements */
        .input-field {
            @apply w-full bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:border-primary-500 focus:ring-1 focus:ring-primary-500 outline-none transition-all placeholder-slate-400 text-slate-800;
        }
        .btn-primary {
            @apply w-full bg-primary-600 text-white font-medium py-3 rounded-lg shadow-sm hover:bg-primary-700 active:scale-[0.98] transition-all;
        }

        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 2px solid white;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col relative">

    <!-- HEADER (Dashboard Style) -->
    <header class="bg-white border-b border-slate-200 pt-safe-top sticky top-0 z-30 shadow-sm" style="padding-top: max(1.5rem, env(safe-area-inset-top));">
        <div class="px-5 pb-3">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xl font-bold text-slate-900 tracking-tight">æ¿Ÿå·å³¶æ—…éŠè¦åŠƒ</h1>
                    <p class="text-xs text-slate-500 font-medium mt-0.5 flex items-center gap-1">
                        <span class="bg-primary-50 text-primary-700 px-1.5 py-0.5 rounded text-[10px] font-bold">2026</span>
                        04.19 - 04.25
                    </p>
                </div>
                <button onclick="loadDataFromCloud()" id="syncBtn" class="p-2 rounded-full hover:bg-slate-50 border border-slate-200 text-slate-600 transition-colors relative group">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 16h5v5"></path></svg>
                    <!-- Tooltip -->
                    <span class="absolute right-0 top-full mt-1 w-max px-2 py-1 bg-slate-800 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">åŒæ­¥é›²ç«¯</span>
                </button>
            </div>

            <!-- Segmented Control Navigation -->
            <div class="bg-slate-100 p-1 rounded-lg flex relative">
                <button onclick="switchTab('itinerary')" class="nav-item flex-1 py-1.5 text-xs font-semibold text-center rounded-md transition-all duration-200 z-10 text-slate-500 active" data-tab="itinerary">è¡Œç¨‹è¡¨</button>
                <button onclick="switchTab('budget')" class="nav-item flex-1 py-1.5 text-xs font-semibold text-center rounded-md transition-all duration-200 z-10 text-slate-500" data-tab="budget">é ç®—è¡¨</button>
                <button onclick="switchTab('todo')" class="nav-item flex-1 py-1.5 text-xs font-semibold text-center rounded-md transition-all duration-200 z-10 text-slate-500" data-tab="todo">å¾…è¾¦äº‹é …</button>
                
                <!-- Animated Background Pill -->
                <div id="nav-pill" class="absolute top-1 bottom-1 left-1 w-[calc(33.33%-0.5rem)] bg-white rounded-md shadow-sm transition-all duration-300 ease-out"></div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app-content" class="flex-1 overflow-y-auto overflow-x-hidden pb-32 px-5 pt-6">
        <!-- Content injected via JS -->
    </main>

    <!-- FLOATING ACTION BUTTON -->
    <button onclick="openAddModal()" class="fab-btn fixed bottom-8 right-6 w-14 h-14 bg-primary-600 rounded-full text-white shadow-float flex items-center justify-center z-40 hover:bg-primary-700 hover:scale-105 active:scale-95 transition-all cursor-pointer">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <!-- MODAL OVERLAY -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] z-50 hidden opacity-0 transition-opacity duration-300 flex items-end sm:items-center justify-center">
        <div id="modal-content" class="bg-white w-full sm:w-[480px] sm:rounded-2xl rounded-t-2xl p-6 transform translate-y-full transition-transform duration-300 max-h-[90vh] overflow-y-auto shadow-2xl safe-pb">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h2 id="modal-title" class="text-lg font-bold text-slate-800">æ–°å¢é …ç›®</h2>
                <button onclick="closeModal()" class="p-1.5 bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100 hover:text-slate-600 transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- TOAST -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2.5 rounded-lg shadow-lg z-[60] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2 text-sm font-medium">
        <span id="toast-msg">å·²å„²å­˜</span>
    </div>

    <!-- SCRIPTS -->
    <script>
        // CONFIG
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvrwnSfsQHluC-bwpAnRcluUZfeAZeIGGNqBZwc_ReoEaxZxzDQcgKq-XSbHUT7LnBnw/exec'; 
        const KRW_TO_TWD = 0.024;
        
        // --- DATA ---
        const DEFAULT_DATA = {
            itinerary: [
                 { id: 'd1-1', day: 1, time: '17:10', title: 'å’ªçˆ¸å¦¹æŠµé” (TW690)', location: 'Jeju Airport', category: 'transport', weather: 'sunny', notes: 'é«˜é›„å‡ºç™¼ 13:40', participants: ['dad_sis'] },
                { id: 'd1-2', day: 1, time: '17:30', title: 'å§Šå§ŠæŠµé” (TW688)', location: 'Jeju Airport', category: 'transport', weather: 'sunny', notes: 'æ¡ƒåœ’å‡ºç™¼ 14:25', participants: ['sister'] },
                { id: 'd1-3', day: 1, time: '18:00', title: 'ç§Ÿè»Šå–è»Š', location: 'Rental Car House', category: 'transport', weather: 'sunny', notes: 'ç¢ºèªè»Šæ³æ‹ç…§', participants: ['all'] },
                { id: 'd1-4', day: 1, time: '19:30', title: 'è¥¿æ­¸æµ¦é»‘è±¬è‚‰', location: 'Seogwipo', category: 'food', weather: 'cloudy', notes: 'ç¬¬ä¸€é¤åƒå¥½çš„ï¼', participants: ['all'] },
                { id: 'd1-5', day: 1, time: '21:00', title: 'å…¥ä½è¥¿æ­¸æµ¦', location: 'Seogwipo Hotel', category: 'hotel', weather: 'cloudy', notes: 'é è¨ˆä½3æ™š', participants: ['all'] },
                
                { id: 'd2-1', day: 2, time: '09:00', title: 'çˆ¸çˆ¸æœƒè­° (APCO)', location: 'Haevichi Hotel', category: 'activity', weather: 'sunny', notes: 'æœƒè­°ç¬¬ä¸€å¤©', participants: ['dad_sis'] },
                { id: 'd2-2', day: 2, time: '10:00', title: 'å²åŠªæ¯”åº­åœ’', location: 'Snoopy Garden', category: 'sights', weather: 'sunny', notes: 'å§Šå¦¹è¡Œç¨‹', participants: ['sister', 'dad_sis'] },
                { id: 'd2-3', day: 2, time: '13:00', title: 'åˆé¤', location: 'Pyoseon Beach', category: 'food', weather: 'sunny', notes: 'è¡¨å–„é™„è¿‘', participants: ['sister', 'dad_sis'] },
                { id: 'd2-4', day: 2, time: '15:00', title: 'æ¶‰åœ°å¯æ”¯', location: 'Seopjikoji', category: 'sights', weather: 'cloudy', notes: 'æ•£æ­¥çœ‹æµ·', participants: ['sister', 'dad_sis'] },
                { id: 'd2-5', day: 2, time: '18:30', title: 'è¥¿æ­¸æµ¦æ¯æ—¥å¶ä¾†å¸‚å ´', location: 'Olle Market', category: 'food', weather: 'cloudy', notes: 'æ™šé¤åƒå°åƒ', participants: ['all'] },

                { id: 'd3-1', day: 3, time: '09:00', title: 'çˆ¸çˆ¸æœƒè­° (APCO)', location: 'Haevichi Hotel', category: 'activity', weather: 'sunny', notes: 'æœƒè­°ç¬¬äºŒå¤©', participants: ['dad_sis'] },
                { id: 'd3-2', day: 3, time: '09:30', title: 'å‰å¾€åŸå±±æ¸¯', location: 'Seongsan Port', category: 'transport', weather: 'sunny', notes: 'æº–å‚™æ­èˆ¹å»ç‰›å³¶', participants: ['sister', 'dad_sis'] },
                { id: 'd3-3', day: 3, time: '10:30', title: 'ç‰›å³¶ç’°å³¶', location: 'Udo Island', category: 'sights', weather: 'sunny', notes: 'é›¨å¤©å‚™æ¡ˆï¼šAqua Planet', participants: ['sister', 'dad_sis'] },
                { id: 'd3-4', day: 3, time: '12:30', title: 'On-Off ç‚¸è±¬æ’', location: 'Udo', category: 'food', weather: 'sunny', notes: 'ç¶²ç´…ååº—ï¼Œéœ€æ’éšŠ', participants: ['sister', 'dad_sis'] },
                { id: 'd3-5', day: 3, time: '15:30', title: 'åŸå±±æ—¥å‡ºå³°', location: 'Seongsan Ilchulbong', category: 'sights', weather: 'cloudy', notes: 'èµ°å…è²»å¤–åœæ­¥é“', participants: ['sister', 'dad_sis'] },
                { id: 'd3-6', day: 3, time: '18:30', title: 'è¥¿æ­¸æµ¦æ™šé¤', location: 'Seogwipo', category: 'food', weather: 'cloudy', notes: 'è¥¿æ­¸æµ¦æœ€å¾Œä¸€æ™š', participants: ['all'] },

                { id: 'd4-1', day: 4, time: '10:00', title: 'é€€æˆ¿å‰å¾€æ–¹èˆŸæ•™æœƒ', location: 'Bangju Church', category: 'sights', weather: 'cloudy', notes: 'ç‰¹è‰²å»ºç¯‰æ‹ç…§', participants: ['all'] },
                { id: 'd4-2', day: 4, time: '12:30', title: 'å§å¦¹éºµæ¢', location: 'Jamae Guksu', category: 'food', weather: 'cloudy', notes: 'è±¬è‚‰æ¹¯éºµ', participants: ['all'] },
                { id: 'd4-3', day: 4, time: '15:00', title: 'å§Šå§Šå…¥ä½ Jade Hotel', location: 'Jade Hotel', category: 'hotel', weather: 'rain', notes: 'æ¿Ÿå·å¸‚å€', participants: ['sister'] },
                { id: 'd4-4', day: 4, time: '16:00', title: 'æ±é–€å¸‚å ´', location: 'Dongmun Market', category: 'shopping', weather: 'rain', notes: 'è²·ä¼´æ‰‹ç¦®', participants: ['all'] },
                { id: 'd4-5', day: 4, time: '19:00', title: 'æ±é–€å¤œå¸‚', location: 'Dongmun Market', category: 'food', weather: 'rain', notes: 'æ™šé¤', participants: ['all'] },

                { id: 'd5-1', day: 5, time: '08:00', title: 'å§Šå§Šå»æ©Ÿå ´ (IT655)', location: 'Jeju Airport', category: 'transport', weather: 'sunny', notes: '10:40 èµ·é£›', participants: ['sister'] },
                { id: 'd5-2', day: 5, time: '10:00', title: 'London Bagel Museum', location: 'London Bagel', category: 'food', weather: 'sunny', notes: 'å’ªçˆ¸å¦¹æ—©åˆé¤', participants: ['dad_sis'] },
                { id: 'd5-3', day: 5, time: '13:00', title: 'æ¢¨æ¹–æœ¨ç­æµ·é‚Š', location: 'Iho Tewoo Beach', category: 'sights', weather: 'sunny', notes: 'ç´…ç™½é¦¬ç‡ˆå¡”', participants: ['dad_sis'] },
                { id: 'd5-4', day: 5, time: '15:00', title: 'å…¥ä½ Gloucester Hotel', location: 'Gloucester Hotel', category: 'hotel', weather: 'sunny', notes: 'æ¿Ÿå·å¸‚', participants: ['dad_sis'] },
                { id: 'd5-5', day: 5, time: '18:00', title: 'å®‡é€²è§£é…’æ¹¯', location: 'Ujin Haejangguk', category: 'food', weather: 'cloudy', notes: 'è‘—åçš„è§£é…’æ¹¯', participants: ['dad_sis'] },

                { id: 'd6-1', day: 6, time: '10:00', title: 'æµ·æ¿±å’–å•¡å»³', location: 'Aewol Cafe', category: 'food', weather: 'sunny', notes: 'æ‚ é–’çœ‹æµ·', participants: ['dad_sis'] },
                { id: 'd6-2', day: 6, time: '13:00', title: 'é»‘è±¬è‚‰åˆé¤', location: 'Jeju City', category: 'food', weather: 'sunny', notes: 'æœ€å¾Œä¸€æ¬¡åƒè‚‰', participants: ['dad_sis'] },
                { id: 'd6-3', day: 6, time: '15:00', title: 'å¸‚å€è³¼ç‰©', location: 'Jeju City', category: 'shopping', weather: 'cloudy', notes: 'å…ç¨…åº—/è¶…å¸‚', participants: ['dad_sis'] },

                { id: 'd7-1', day: 7, time: '08:30', title: 'å‰å¾€æ©Ÿå ´é‚„è»Š', location: 'Rental Car House', category: 'transport', weather: 'sunny', notes: 'é ç•™æ™‚é–“é‚„è»Š', participants: ['dad_sis'] },
                { id: 'd7-2', day: 7, time: '11:15', title: 'å’ªçˆ¸å¦¹èµ·é£› (TW689)', location: 'Jeju Airport', category: 'transport', weather: 'sunny', notes: 'å›é«˜é›„', participants: ['dad_sis'] },
            ],
            budget: [
                { id: 1, title: 'é ä¼°ç§Ÿè»Šè²»', amount: 300000, payer: 'sister', category: 'transport', date: '2026-04-19' },
                { id: 2, title: 'ç¬¬ä¸€å¤©æ™šé¤', amount: 80000, payer: 'dad_sis', category: 'food', date: '2026-04-19' },
            ],
            todos: [
                { id: 1, title: 'ç¢ºèªåœ‹éš›é§•ç…§', done: false, participants: ['all'], needPay: false },
                { id: 2, title: 'é è¨‚ On-Off ç‚¸è±¬æ’', done: false, participants: ['sister'], needPay: false },
                { id: 3, title: 'è²· T-money å¡', done: true, participants: ['all'], needPay: true },
            ]
        };

        let appData = JSON.parse(localStorage.getItem('jejuTripData')) || DEFAULT_DATA;
        let currentTab = 'itinerary';
        let currentDay = 1;

        // --- CORE FUNCTIONS ---
        const saveToLocal = () => localStorage.setItem('jejuTripData', JSON.stringify(appData));
        const formatMoney = (num) => new Intl.NumberFormat('en-US').format(num);
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // --- SYNC FUNCTIONS ---
        function syncToGoogleSheets(type, data) {
            if (!GOOGLE_SCRIPT_URL.includes('script.google.com')) return Promise.reject('URL not set');
            return fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, data })
            }).then(() => console.log('Synced:', type));
        }

        async function loadDataFromCloud() {
             const btn = document.getElementById('syncBtn');
             btn.innerHTML = `<div class="spinner"></div>`;
             btn.disabled = true;
             
             try {
                 const res = await fetch(GOOGLE_SCRIPT_URL + '?t=' + Date.now()); 
                 const data = await res.json();
                 if(data.itinerary || data.budget || data.todos) {
                     appData = {
                         itinerary: data.itinerary || [],
                         budget: data.budget || [],
                         todos: data.todos || []
                     };
                     saveToLocal();
                     render();
                     showToast('è³‡æ–™å·²æ›´æ–°');
                 } else {
                     showToast('é›²ç«¯ç„¡è³‡æ–™');
                 }
             } catch(e) {
                 console.error(e);
                 showToast('è®€å–å¤±æ•—');
             } finally {
                 btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 16h5v5"></path></svg>`;
                 btn.disabled = false;
             }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-20px]'), 2000);
        }

        // --- UI RENDERERS ---
        function render() {
            const content = document.getElementById('app-content');
            content.innerHTML = '';
            if (currentTab === 'itinerary') renderItinerary(content);
            else if (currentTab === 'budget') renderBudget(content);
            else if (currentTab === 'todo') renderTodo(content);
            updateNavPill();
        }

        function renderItinerary(container) {
            // Day Selector
            const days = [1, 2, 3, 4, 5, 6, 7];
            const dates = ['4/19', '4/20', '4/21', '4/22', '4/23', '4/24', '4/25'];
            const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            
            const daySelector = document.createElement('div');
            daySelector.className = 'flex gap-3 overflow-x-auto hide-scrollbar pb-6 snap-x';
            daySelector.innerHTML = days.map((d, index) => {
                const isActive = currentDay === d;
                const activeClasses = 'bg-slate-800 text-white shadow-lg ring-2 ring-slate-800 ring-offset-2';
                const inactiveClasses = 'bg-white text-slate-500 border border-slate-200 hover:border-slate-300';
                
                return `
                <button onclick="setDay(${d})" class="snap-start flex-shrink-0 w-[4.5rem] h-20 rounded-xl flex flex-col items-center justify-center transition-all duration-200 ${isActive ? activeClasses : inactiveClasses}">
                    <span class="text-[10px] font-medium opacity-80">${dates[index]}</span>
                    <span class="text-xl font-bold font-sans">D${d}</span>
                    <span class="text-[10px] font-medium opacity-60 mt-0.5">${weekdays[index]}</span>
                </button>
            `}).join('');
            container.appendChild(daySelector);

            // Timeline
            const wrapper = document.createElement('div');
            wrapper.className = 'timeline-container mt-2';
            
            const dayItems = appData.itinerary.filter(i => i.day === currentDay).sort((a,b) => a.time.localeCompare(b.time));

            if (dayItems.length === 0) {
                 wrapper.innerHTML = `<div class="text-center py-12 px-4 border-2 border-dashed border-slate-200 rounded-xl"><p class="text-slate-400 text-sm">é»æ“Š + æ–°å¢ä»Šæ—¥è¡Œç¨‹</p></div>`;
            } else {
                dayItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'timeline-item relative pl-6 pb-8 last:pb-0 group cursor-pointer';
                    el.onclick = () => openModal('itinerary', item.id);
                    
                    const time = item.time || "å…¨å¤©";
                    const location = item.location || item.title;
                    const catColor = getCategoryColor(item.category);

                    el.innerHTML = `
                        <div class="timeline-line"></div>
                        <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-white border-2 ${catColor.border} flex items-center justify-center z-10 shadow-sm group-hover:scale-110 transition-transform">
                            <div class="w-2 h-2 rounded-full ${catColor.bg}"></div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 shadow-card border border-slate-100 hover:shadow-float hover:border-primary-200 transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold font-mono text-slate-500 bg-slate-50 px-2 py-0.5 rounded">${time}</span>
                                ${renderMiniAvatars(item.participants)}
                            </div>
                            <h3 class="text-base font-bold text-slate-800 leading-tight mb-1">${item.title}</h3>
                            
                            <a href="https://map.naver.com/v5/search/${location}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center gap-1 text-xs text-secondary font-medium hover:underline mb-2">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                ${location}
                            </a>
                            
                            ${item.notes ? `<div class="mt-2 text-xs text-slate-500 bg-slate-50 p-2.5 rounded border-l-2 border-slate-300 whitespace-pre-line leading-relaxed">${item.notes}</div>` : ''}
                        </div>
                    `;
                    wrapper.appendChild(el);
                });
            }
            container.appendChild(wrapper);
        }

        // 2. BUDGET
        function renderBudget(container) {
            const totalKRW = appData.budget.reduce((acc, curr) => acc + parseInt(curr.amount), 0);
            const totalTWD = Math.round(totalKRW * KRW_TO_TWD);
            const sisterTotal = appData.budget.filter(b => b.payer === 'sister').reduce((acc, curr) => acc + parseInt(curr.amount), 0);
            const familyTotal = appData.budget.filter(b => b.payer === 'dad_sis').reduce((acc, curr) => acc + parseInt(curr.amount), 0);

            const summary = document.createElement('div');
            summary.className = 'bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl p-6 shadow-float mb-6';
            summary.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-medium text-slate-400 uppercase tracking-wide">ç¸½æ”¯å‡º</p>
                        <h2 class="text-3xl font-bold mt-1 font-mono">â‚©${formatMoney(totalKRW)}</h2>
                        <p class="text-sm text-slate-400 mt-1">â‰ˆ NT$${formatMoney(totalTWD)}</p>
                    </div>
                    <div class="p-2 bg-white/10 rounded-lg"><svg width="24" height="24" stroke="currentColor" fill="none" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t border-white/10">
                    <div><p class="text-[10px] text-slate-400">å§Šå§Š</p><p class="font-bold font-mono">â‚©${formatMoney(sisterTotal)}</p></div>
                    <div><p class="text-[10px] text-slate-400">å’ªçˆ¸å¦¹</p><p class="font-bold font-mono">â‚©${formatMoney(familyTotal)}</p></div>
                </div>
            `;
            container.appendChild(summary);

            const sortedList = [...appData.budget].sort((a,b) => new Date(b.date) - new Date(a.date));
            const list = document.createElement('div');
            list.className = 'space-y-3';
            
            if(sortedList.length === 0) list.innerHTML = `<p class="text-center text-slate-400 text-sm py-8">ç„¡è¨˜å¸³è³‡æ–™</p>`;
            else list.innerHTML = sortedList.map(item => `
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border border-slate-100 shadow-sm cursor-pointer hover:border-primary-200 transition-colors" onclick="openModal('budget', '${item.id}')">
                    <div class="flex items-center gap-3.5">
                         <div class="w-10 h-10 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-lg shadow-sm">${getCategoryIcon(item.category)}</div>
                         <div>
                            <h4 class="font-bold text-slate-800 text-sm">${item.title}</h4>
                            <p class="text-[10px] text-slate-500 font-medium">${item.date} Â· ${item.payer === 'sister' ? 'å§Šå§Š' : 'å’ªçˆ¸å¦¹'}</p>
                         </div>
                    </div>
                    <p class="font-bold text-slate-700 font-mono text-sm">â‚©${formatMoney(item.amount)}</p>
                </div>
            `).join('');
            container.appendChild(list);
        }

        // 3. TODO
        function renderTodo(container) {
            const list = document.createElement('div');
            list.className = 'space-y-3';
            const sortedTodos = [...appData.todos].sort((a,b) => a.done - b.done);

            if(sortedTodos.length === 0) list.innerHTML = `<p class="text-center text-slate-400 text-sm py-10">å¾…è¾¦äº‹é …æ¸…å–®æ˜¯ç©ºçš„</p>`;
            else list.innerHTML = sortedTodos.map(item => `
                <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-start gap-3 cursor-pointer ${item.done ? 'opacity-50' : ''}" onclick="openModal('todo', '${item.id}')">
                    <div class="pt-0.5" onclick="event.stopPropagation()">
                        <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleTodo('${item.id}')" class="w-5 h-5 rounded border-slate-300 text-primary-600 focus:ring-primary-500 cursor-pointer">
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-800 text-sm ${item.done ? 'line-through text-slate-400' : ''}">${item.title}</h4>
                        <div class="flex gap-2 mt-2">
                            ${renderMiniAvatars(item.participants)}
                            ${item.needPay && !item.done ? `<button onclick="event.stopPropagation(); transferToBudget('${item.title}')" class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded border border-emerald-100 font-bold">åŠ å…¥è¨˜å¸³</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            container.appendChild(list);
        }

        // --- UTILS ---
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('text-slate-900', btn.dataset.tab === tab);
                btn.classList.toggle('text-slate-500', btn.dataset.tab !== tab);
            });
            render();
        }
        
        function updateNavPill() {
            const pill = document.getElementById('nav-pill');
            const activeBtn = document.querySelector(`.nav-item[data-tab="${currentTab}"]`);
            if(activeBtn) {
                pill.style.transform = `translateX(${activeBtn.offsetLeft}px)`;
                pill.style.width = `${activeBtn.offsetWidth}px`;
            }
        }
        
        function setDay(d) { currentDay = d; render(); }
        
        function getCategoryColor(cat) {
            const map = {
                'food': { border: 'border-orange-400', bg: 'bg-orange-400' },
                'sights': { border: 'border-sky-400', bg: 'bg-sky-400' },
                'shopping': { border: 'border-pink-400', bg: 'bg-pink-400' },
                'activity': { border: 'border-indigo-400', bg: 'bg-indigo-400' },
                'transport': { border: 'border-emerald-400', bg: 'bg-emerald-400' },
                'hotel': { border: 'border-slate-400', bg: 'bg-slate-400' }
            };
            return map[cat] || { border: 'border-slate-300', bg: 'bg-slate-300' };
        }
        function getCategoryName(cat) { 
            const map = { 'food': 'ç¾é£Ÿ', 'sights': 'æ™¯é»', 'shopping': 'è³¼ç‰©', 'activity': 'æ´»å‹•', 'transport': 'äº¤é€š', 'hotel': 'ä½å®¿' }; 
            return map[cat] || 'å…¶ä»–'; 
        }
        function getCategoryIcon(cat) { 
            const map = { 'food': 'ğŸ”', 'sights': 'ğŸ“¸', 'shopping': 'ğŸ›ï¸', 'activity': 'ğŸ«', 'transport': 'ğŸš—', 'hotel': 'ğŸ¨' }; 
            return map[cat] || 'ğŸ“Œ'; 
        }
        
        function renderMiniAvatars(parts) {
            if(!parts) return '';
            const isSis = parts.includes('sister'); const isDad = parts.includes('dad_sis'); const isAll = parts.includes('all') || (isSis && isDad);
            if(isAll) return `<span class="text-[10px] text-slate-600 font-bold bg-slate-100 px-1.5 py-0.5 rounded">å…¨å“¡</span>`;
            let html = '';
            if(isSis) html += `<span class="text-[10px] text-indigo-600 font-bold bg-indigo-50 px-1.5 py-0.5 rounded mr-1">å§Šå§Š</span>`;
            if(isDad) html += `<span class="text-[10px] text-sky-600 font-bold bg-sky-50 px-1.5 py-0.5 rounded">å’ªçˆ¸å¦¹</span>`;
            return html;
        }

        // --- ACTIONS ---
        function openModal(type, editId = null) {
            if(!type) type = currentTab;
            const m = document.getElementById('modal-overlay');
            m.classList.remove('hidden');
            setTimeout(() => {
                m.classList.remove('opacity-0');
                document.getElementById('modal-content').classList.remove('translate-y-full');
            }, 10);

            // Populate Form
            const body = document.getElementById('modal-body');
            const titleEl = document.getElementById('modal-title');
            
            let data = null;
            if(editId) {
                if(type === 'itinerary') data = appData.itinerary.find(i => i.id === editId);
                else if(type === 'budget') data = appData.budget.find(i => i.id === editId);
                else if(type === 'todo') data = appData.todos.find(i => i.id === editId);
            }
            
            titleEl.innerText = (data ? 'ç·¨è¼¯' : 'æ–°å¢') + (type === 'itinerary' ? 'è¡Œç¨‹' : type === 'budget' ? 'è¨˜å¸³' : 'å¾…è¾¦');
            
            let form = '';
            if(type === 'itinerary') {
                const day = data ? data.day : currentDay;
                const time = data ? data.time : '';
                const title = data ? data.title : '';
                const loc = data ? data.location : '';
                const notes = data ? data.notes : '';
                const cat = data ? data.category : 'food';
                const p_sis = data ? data.participants.includes('sister') || data.participants.includes('all') : true;
                const p_dad = data ? data.participants.includes('dad_sis') || data.participants.includes('all') : true;

                form = `
                <form onsubmit="handleSubmit(event, 'itinerary')" class="space-y-4">
                    ${editId ? `<input type="hidden" name="id" value="${editId}">` : ''}
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">å¤©æ•¸</label><select name="day" class="input-field">${[1,2,3,4,5,6,7].map(d=>`<option value="${d}" ${d===day?'selected':''}>D${d}</option>`).join('')}</select></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">æ™‚é–“</label><input type="time" name="time" value="${time}" required class="input-field"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">æ¨™é¡Œ</label><input type="text" name="title" value="${title}" required class="input-field"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">åœ°é» (Naver Map)</label><input type="text" name="location" value="${loc}" required class="input-field"></div>
                    
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">åˆ†é¡</label>
                    <div class="grid grid-cols-3 gap-2">
                        ${['food','sights','shopping','activity','transport','hotel'].map(c => `
                            <label class="cursor-pointer text-center"><input type="radio" name="category" value="${c}" class="peer hidden" ${c===cat?'checked':''}><span class="block py-2 bg-slate-50 rounded text-xs font-medium text-slate-500 border border-transparent peer-checked:bg-primary-50 peer-checked:text-primary-700 peer-checked:border-primary-200 transition-all">${getCategoryName(c)}</span></label>
                        `).join('')}
                    </div></div>

                    <div class="flex gap-4 pt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="p_sister" ${p_sis?'checked':''} class="w-4 h-4 rounded text-primary-600 focus:ring-primary-500"><span class="text-sm font-medium">å§Šå§Š</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="p_family" ${p_dad?'checked':''} class="w-4 h-4 rounded text-primary-600 focus:ring-primary-500"><span class="text-sm font-medium">å’ªçˆ¸å¦¹</span></label>
                    </div>

                    <div><label class="block text-xs font-bold text-slate-500 mb-1">å‚™è¨»</label><textarea name="notes" rows="3" class="input-field">${notes}</textarea></div>
                    <button type="submit" id="submitBtn" class="btn-primary">å„²å­˜è®Šæ›´</button>
                </form>`;
            } else if (type === 'budget') {
                const title = data ? data.title : '';
                const amt = data ? data.amount : '';
                const payer = data ? data.payer : 'sister';
                const cat = data ? data.category : 'food';
                form = `
                <form onsubmit="handleSubmit(event, 'budget')" class="space-y-4">
                    ${editId ? `<input type="hidden" name="id" value="${editId}">` : ''}
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">é …ç›®</label><input type="text" name="title" id="b-title" value="${title}" required class="input-field"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡ (éŸ“å…ƒ)</label><input type="number" name="amount" value="${amt}" required class="input-field font-mono"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer text-center"><input type="radio" name="payer" value="sister" class="peer hidden" ${payer==='sister'?'checked':''}><span class="block py-2.5 bg-slate-50 rounded-lg text-sm font-medium text-slate-500 border border-transparent peer-checked:bg-indigo-50 peer-checked:text-indigo-700 peer-checked:border-indigo-200">å§Šå§Š Pay</span></label>
                        <label class="cursor-pointer text-center"><input type="radio" name="payer" value="dad_sis" class="peer hidden" ${payer==='dad_sis'?'checked':''}><span class="block py-2.5 bg-slate-50 rounded-lg text-sm font-medium text-slate-500 border border-transparent peer-checked:bg-sky-50 peer-checked:text-sky-700 peer-checked:border-sky-200">å’ªçˆ¸å¦¹ Pay</span></label>
                    </div>
                    
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">åˆ†é¡</label><select name="category" class="input-field">
                        <option value="food" ${cat==='food'?'selected':''}>ç¾é£Ÿ</option>
                        <option value="transport" ${cat==='transport'?'selected':''}>äº¤é€š</option>
                        <option value="shopping" ${cat==='shopping'?'selected':''}>è³¼ç‰©</option>
                        <option value="ticket" ${cat==='ticket'?'selected':''}>ç¥¨åˆ¸</option>
                        <option value="hotel" ${cat==='hotel'?'selected':''}>ä½å®¿</option>
                    </select></div>
                    <button type="submit" id="submitBtn" class="btn-primary">å„²å­˜æ”¯å‡º</button>
                </form>`;
            } else {
                const title = data ? data.title : '';
                const needPay = data ? data.needPay : false;
                form = `
                <form onsubmit="handleSubmit(event, 'todo')" class="space-y-4">
                    ${editId ? `<input type="hidden" name="id" value="${editId}">` : ''}
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">å¾…è¾¦äº‹é …</label><input type="text" name="title" value="${title}" required class="input-field"></div>
                    <div class="flex items-center gap-3 pt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="needPay" ${needPay?'checked':''} class="w-5 h-5 rounded text-primary-600 focus:ring-primary-500"><span class="text-sm font-medium text-slate-700">éœ€è¦ä»˜æ¬¾ï¼Ÿ</span></label>
                    </div>
                    <button type="submit" id="submitBtn" class="btn-primary">å„²å­˜å¾…è¾¦</button>
                </form>`;
            }
            body.innerHTML = form;
        }

        function closeModal() {
            const m = document.getElementById('modal-overlay'); m.classList.add('opacity-0'); document.getElementById('modal-content').classList.add('translate-y-full'); setTimeout(() => m.classList.add('hidden'), 300);
        }
        function openAddModal() { openModal(currentTab); }
        function transferToBudget(title) { switchTab('budget'); openModal('budget'); setTimeout(()=>document.getElementById('b-title').value=title, 100); }
        function toggleTodo(id) { const t = appData.todos.find(i=>i.id==id); if(t){t.done=!t.done; saveToLocal(); render();} }

        // --- SUBMIT ---
        function handleSubmit(e, type) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = `<div class="flex justify-center"><div class="spinner"></div></div>`;
            btn.disabled = true;

            const fd = new FormData(e.target);
            const editId = fd.get('id');
            let item = {};

            if(type === 'itinerary') {
                const parts = [];
                if(fd.get('p_sister')) parts.push('sister');
                if(fd.get('p_family')) parts.push('dad_sis');
                if(parts.length===0) parts.push('all');
                
                item = {
                    id: editId || generateId(),
                    day: parseInt(fd.get('day')),
                    time: fd.get('time'),
                    title: fd.get('title'),
                    location: fd.get('location'),
                    category: fd.get('category'),
                    notes: fd.get('notes'),
                    participants: parts,
                    weather: 'sunny'
                };
                if(editId) {
                    const idx = appData.itinerary.findIndex(i=>i.id===editId);
                    if(idx!==-1) appData.itinerary[idx] = item;
                } else {
                    appData.itinerary.push(item);
                }
                currentDay = item.day;
            } else if(type === 'budget') {
                item = {
                    id: editId || generateId(),
                    title: fd.get('title'),
                    amount: parseInt(fd.get('amount')),
                    payer: fd.get('payer'),
                    category: fd.get('category'),
                    date: new Date().toISOString().split('T')[0]
                };
                if(editId) {
                    const idx = appData.budget.findIndex(i=>i.id===editId);
                    if(idx!==-1) appData.budget[idx] = item;
                } else appData.budget.unshift(item);
            } else {
                item = {
                    id: editId || generateId(),
                    title: fd.get('title'),
                    done: false,
                    needPay: fd.get('needPay')==='on',
                    participants: ['all']
                };
                if(editId) {
                    const old = appData.todos.find(i=>i.id===editId);
                    if(old) item.done = old.done;
                    const idx = appData.todos.findIndex(i=>i.id===editId);
                    if(idx!==-1) appData.todos[idx] = item;
                } else appData.todos.push(item);
            }

            saveToLocal();
            syncToGoogleSheets(type, item);
            
            setTimeout(() => {
                closeModal();
                render();
            }, 300);
        }

        // Init
        window.addEventListener('load', () => {
            updateNavPill();
            render();
        });
    </script>
</body>
</html>
